name: CI

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

on:
  push:
    branches: [main, master]
    paths-ignore:
      - "**.md"
      - "brain/**"
      - ".agent/**"
      - "LICENSE"
      - "assets/**"
  pull_request:
    branches: [main, master]
    paths-ignore:
      - "**.md"
      - "brain/**"
      - ".agent/**"
      - "LICENSE"
      - "assets/**"

jobs:
  lint:
    name: Lint & Code Quality
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements_test.txt

      - name: Run Black (Formatting)
        run: |
          black --check --force-exclude "tests/mock_ha/.*" custom_components/custody_schedule tests

      - name: Run Isort (Import sorting)
        run: |
          isort --check-only --skip-glob "tests/mock_ha/*" custom_components/custody_schedule tests

      - name: Run Flake8 (Linting)
        run: |
          # F401: Module imported but not used (ignored in __init__.py often, but good to check)
          # E501: Line too long (handled by black mostly, but flake8 is strict)
          # W503: Line break before binary operator (conflicts with black)
          flake8 custom_components/custody_schedule tests --exclude="tests/mock_ha" --count --select=E9,F63,F7,F82 --show-source --statistics
          flake8 custom_components/custody_schedule tests --exclude="tests/mock_ha" --count --max-complexity=10 --max-line-length=127 --statistics

      - name: Run YamlLint
        run: |
          yamllint .

  security:
    name: Security Scan
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"

      - name: Install dependencies
        run: |
          pip install bandit

      - name: Run Bandit (Security)
        run: |
          bandit -r custom_components/custody_schedule

  test:
    name: Unit Tests
    runs-on: ubuntu-latest
    # Removed dependency on lint to allow parallel execution
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"
          cache-dependency-path: |
            requirements.txt
            requirements_test.txt

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install -r requirements_test.txt
          pip install pytest-cov

      - name: Run Pytest with Coverage
        run: |
          pytest tests --cov=custom_components/custody_schedule --cov-report=term-missing --cov-report=xml

      - name: Upload Coverage Report
        uses: codecov/codecov-action@v4
        with:
          file: ./coverage.xml
          fail_ci_if_error: false
        continue-on-error: true

  hassfest:
    name: Hassfest Validation
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run Hassfest
        uses: home-assistant/actions/hassfest@master

  hacs:
    name: HACS Validation
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run HACS Validation
        uses: hacs/action@main
        with:
          category: integration
          ignore: brands

  core-compatibility:
    name: Core Compatibility Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check manifest for Core requirements
        run: |
          echo "Checking manifest compatibility with Home Assistant Core..."
          MANIFEST="custom_components/custody_schedule/manifest.json"

          # Check for 'version' field (required for custom, forbidden for Core)
          if grep -q '"version"' "$MANIFEST"; then
            echo "ℹ️  INFO: 'version' field found (required for custom integration)"
            echo "    If submitting to Core, this field must be removed."
          fi

          # Check for 'integration_type' (will be required for Core)
          if ! grep -q '"integration_type"' "$MANIFEST"; then
            echo "⚠️  WARNING: Missing 'integration_type' field"
            echo "    This will be required for Core integration."
            echo "    Suggested value: 'service' or 'helper'"
          else
            INTEGRATION_TYPE=$(grep -o '"integration_type"[[:space:]]*:[[:space:]]*"[^"]*"' "$MANIFEST" | cut -d'"' -f4)
            echo "✓ integration_type found: $INTEGRATION_TYPE"
          fi

          # Check documentation URL
          DOC_URL=$(grep -o '"documentation"[[:space:]]*:[[:space:]]*"[^"]*"' "$MANIFEST" | cut -d'"' -f4)
          if echo "$DOC_URL" | grep -q "home-assistant.io/integrations"; then
            echo "✓ Documentation URL points to official docs (Core-ready)"
          else
            echo "ℹ️  INFO: Documentation URL: $DOC_URL"
            echo "    For Core submission, should be: https://www.home-assistant.io/integrations/custody_schedule"
          fi

          echo ""
          echo "Summary: Current configuration is optimized for custom integration."
          echo "No action needed unless planning Core submission."
